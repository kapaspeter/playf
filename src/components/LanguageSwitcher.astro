---
import { getRelativeLocaleUrl } from '../utils/i18n';
import { getCollection } from 'astro:content';

const { pathname } = Astro.url;
const currentLocale = Astro.currentLocale || Astro.params.lang || 'en';

// Extract slug from pathname: e.g. "/en/about" -> "about"
const pathParts = pathname.split('/').filter(Boolean);
const currentUrlSlug = pathParts.length > 1 ? pathParts.slice(1).join('/') : '';

// Get all available pages to check for existence in other languages
const allPages = await getCollection('pages');

// Find the current page filename (e.g. "about" if on "/hu/rolunk")
const currentPage = allPages.find(page => {
  const parts = page.id.split('/');
  const lang = parts[0];
  const fileSlug = parts.slice(1).join('/');
  const slugInPage = page.data.slug || fileSlug;
  return lang === currentLocale && slugInPage === currentUrlSlug;
});

const currentFilename = currentPage ? currentPage.id.split('/').slice(1).join('/') : '';

const locales = [
  { code: 'en', name: 'English', label: 'EN' },
  { code: 'hu', name: 'Magyar', label: 'HU' },
  { code: 'ro', name: 'Română', label: 'RO' },
];

const currentLocaleData = locales.find(l => l.code === currentLocale) || locales[0];

// Helper to get link for a specific locale
const getLocaleLink = (localeCode: string) => {
  if (!currentFilename) return getRelativeLocaleUrl(localeCode, '');
  
  // Find the page in the target locale with the same filename
  const targetPage = allPages.find(page => page.id === `${localeCode}/${currentFilename}`);
  
  if (targetPage) {
    const targetSlug = targetPage.data.slug || currentFilename;
    return getRelativeLocaleUrl(localeCode, targetSlug);
  }
  
  return getRelativeLocaleUrl(localeCode, '');
};
---

<div class="language-dropdown">
  <button class="dropdown-trigger" aria-haspopup="true" aria-expanded="false">
    <span class="flag-icon">
      {currentLocale === 'en' && (
        <svg viewBox="0 0 60 30" width="20" height="10">
          <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
          <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
          <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
        </svg>
      )}
      {currentLocale === 'hu' && (
        <svg viewBox="0 0 3 2" width="20" height="13.3">
          <rect width="3" height="0.67" fill="#C2242E"/>
          <rect y="0.67" width="3" height="0.67" fill="#FFF"/>
          <rect y="1.34" width="3" height="0.67" fill="#436F4D"/>
        </svg>
      )}
      {currentLocale === 'ro' && (
        <svg viewBox="0 0 3 2" width="20" height="13.3">
          <rect width="1" height="2" fill="#002B7F"/>
          <rect x="1" width="1" height="2" fill="#FCD116"/>
          <rect x="2" width="1" height="2" fill="#CE1126"/>
        </svg>
      )}
    </span>
    <span class="locale-label">{currentLocaleData.label}</span>
    <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
  </button>
  
  <div class="dropdown-menu">
    {locales.map((locale) => (
      <a 
        href={getLocaleLink(locale.code)} 
        class={currentLocale === locale.code ? 'active' : ''}
      >
        <span class="flag-icon">
          {locale.code === 'en' && (
            <svg viewBox="0 0 60 30" width="20" height="10">
              <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
              <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
              <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
              <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
              <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
            </svg>
          )}
          {locale.code === 'hu' && (
            <svg viewBox="0 0 3 2" width="20" height="13.3">
              <rect width="3" height="0.67" fill="#C2242E"/>
              <rect y="0.67" width="3" height="0.67" fill="#FFF"/>
              <rect y="1.34" width="3" height="0.67" fill="#436F4D"/>
            </svg>
          )}
          {locale.code === 'ro' && (
            <svg viewBox="0 0 3 2" width="20" height="13.3">
              <rect width="1" height="2" fill="#002B7F"/>
              <rect x="1" width="1" height="2" fill="#FCD116"/>
              <rect x="2" width="1" height="2" fill="#CE1126"/>
            </svg>
          )}
        </span>
        {locale.name}
      </a>
    ))}
  </div>
</div>

<script>
  function setupLanguageSwitcher() {
    const dropdown = document.querySelector('.language-dropdown');
    const trigger = dropdown?.querySelector('.dropdown-trigger');
    
    if (!trigger || !dropdown) return;

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
      trigger.setAttribute('aria-expanded', String(!isExpanded));
      dropdown.classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target as Node)) {
        trigger.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('open');
      }
    });
  }

  // Initialize on load
  setupLanguageSwitcher();
  // Also re-initialize on Astro page loads (if using transitions)
  document.addEventListener('astro:after-swap', setupLanguageSwitcher);
</script>

<style>
  .language-dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    background: none;
    border: 1px solid var(--border-color);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    color: var(--text-body);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  .dropdown-trigger:hover {
    background-color: var(--bg-surface);
  }

  .flag-icon {
    display: flex;
    align-items: center;
    border: 1px solid rgba(0,0,0,0.1);
    line-height: 0;
    flex-shrink: 0;
  }

  .locale-label {
    margin-left: 2px;
  }

  .chevron {
    transition: transform 0.2s;
    opacity: 0.7;
  }

  .open .chevron {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + var(--space-xs));
    right: 0;
    background-color: var(--bg-body);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    display: none;
    flex-direction: column;
    min-width: 160px;
    z-index: 2000;
    overflow: hidden;
  }

  .open .dropdown-menu {
    display: flex;
  }

  .dropdown-menu a {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    text-decoration: none;
    color: var(--text-body);
    font-size: 0.9rem;
    transition: background-color 0.2s;
  }

  .dropdown-menu a:hover {
    background-color: var(--bg-surface-alt);
  }

  .dropdown-menu a.active {
    color: var(--color-primary);
    font-weight: 600;
    background-color: var(--bg-surface);
  }
</style>
