---
import prisma from '../../lib/prisma';
import Layout from '../../layouts/Layout.astro';
import BlockedDaysManager from '../../components/BlockedDaysManager';

export const prerender = false;

const adminPassword = process.env.ADMIN_PASSWORD || 'admin123';
const authCookie = Astro.cookies.get('admin_session');
const isAuthenticated = authCookie?.value === adminPassword;

let reservations = [];
if (isAuthenticated) {
  reservations = await prisma.reservation.findMany({
    orderBy: {
      date: 'desc',
    },
  });
}
---

<Layout title="Admin Dashboard - Reservations">
  <main class="container" style="padding: var(--space-xl) var(--space-md); flex: 1; position: relative;">
    {!isAuthenticated ? (
      <div class="login-overlay">
        <div class="login-box">
          <h2>Admin Login</h2>
          <form id="login-form">
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" name="password" required />
            </div>
            <button type="submit">Login</button>
            <p id="error-msg" class="error" style="display: none;">Invalid password</p>
          </form>
        </div>
      </div>
    ) : (
      <>
        <h1>Admin: Reservations</h1>
        
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Participants</th>
                <th>Package</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {reservations.map((res) => (
                <tr>
                  <td>{res.date}</td>
                  <td>{res.time}</td>
                  <td>{res.name}</td>
                  <td>{res.phone}</td>
                  <td>{res.participants}</td>
                  <td>{res.package}</td>
                  <td><span class={`status ${res.status.toLowerCase()}`}>{res.status}</span></td>
                </tr>
              ))}
              {reservations.length === 0 && (
                <tr>
                  <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No reservations found.</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        <BlockedDaysManager client:load />
      </>
    )}
  </main>
</Layout>

<script>
  const loginForm = document.getElementById('login-form') as HTMLFormElement;
  const errorMsg = document.getElementById('error-msg');

  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = (document.getElementById('password') as HTMLInputElement).value;
      
      const res = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      if (res.ok) {
        window.location.reload();
      } else {
        if (errorMsg) errorMsg.style.display = 'block';
      }
    });
  }
</script>

<style>
  .login-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    min-height: 400px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: var(--space-xxl);
    background-color: var(--bg-body);
    z-index: 100;
  }

  .login-box {
    background-color: var(--bg-surface);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 400px;
  }

  .login-box h2 {
    margin-bottom: var(--space-lg);
    text-align: center;
  }

  .form-group {
    margin-bottom: var(--space-md);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: bold;
    font-size: 0.9rem;
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
    background-color: var(--bg-body);
    color: var(--text-body);
  }

  .login-box button {
    width: 100%;
    padding: 0.75rem;
    background-color: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: bold;
    cursor: pointer;
  }

  .error {
    color: var(--color-accent);
    margin-top: var(--space-sm);
    text-align: center;
    font-size: 0.9rem;
  }

  .table-wrapper {
    overflow-x: auto;
    margin-top: var(--space-xl);
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
    color: var(--text-body);
  }

  th, td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-color);
  }

  th {
    background-color: var(--bg-surface-alt);
    font-weight: bold;
    color: var(--text-heading);
  }

  .status {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: bold;
  }

  .status.pending { background-color: #fff3e0; color: #e65100; }
  .status.confirmed { background-color: #e8f5e9; color: #2e7d32; }
  .status.cancelled { background-color: #ffebee; color: #c62828; }

  h1 {
    color: var(--text-heading);
  }
</style>
